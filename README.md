# SalesforceCICD with CircleCI
This repository was created because I could not find any good CI/CD examples for the org-based development process of SFDX utilizing a production/master branch, an integration and testing sandbox and branch, and various feature/hotfix branches. 

# Assumptions
This repo is built following the structure of an SFDX project using Visual Studio Code and the associated plugins for VSCode. Our project structure was converted from the old force IDE structure to the SFDX structure following [this article](https://forcedotcom.github.io/salesforcedx-vscode/articles/getting-started/migrate-from-forcecom-ide). Therefore, our source is src/main/default instead of just main/default. 

# Using this repository
You could clone this repository and use SFDX to pull your source into a new repo and lose your existing git history.

You could also just cherrypick the files that you want. The most important ones are the files in assets and the .circleci folder. 

# Setting Up Authentication for SFDX and CircleCI
CircleCI relies on JSON Web Tokens (JWT) to authenticate using the SFDX CLI which means that you must be able to create and encrypt SSH keys and also have administrator rights within SalesForce to create a new connected app.

The jist of this process is that a self-signed certificate is generated by you and then assigned to a connected app. The key used to generate the self signed certificate is then encrypted to allow you to later decrypt it in the circleci job in order to log into SalesForce.

These steps must be followed to successfully authenticate using the JWT flow: 
1. [Create a private key and self-signed digital cert]( https://developer.salesforce.com/docs/atlas.en-us.sfdx_dev.meta/sfdx_dev/sfdx_dev_auth_key_and_cert.htm)
1.  [Create a connected app for JWT](https://developer.salesforce.com/docs/atlas.en-us.sfdx_dev.meta/sfdx_dev/sfdx_dev_auth_connected_app.htm)
	1.  To encrypt/decrypt private key:
		1.  Encrypt the password that you want to use for deployments. Run:
			 `openssl enc -aes-256-cbc -k <deployment user's passphrase here> -P -md sha1 -nosalt`
		1.  Record output of key and iv, add into project as environment variables in circleci ($SANDBOX_DECRYPTION_KEY, $SANDBOX_DECRYPTION_IV)
		1. Encrypt the key that was generated above  Run command:
			`openssl enc -nosalt -aes-256-cbc -in <key name from step 1> -out assets/<key name from step 1>.enc -base64 -K <key from above> -iv <iv from above>`
	1. Record the client id and store as an environment variable in circleci ($SANDBOX_CLIENT_ID)
	1. Create and store the username that you will be using to do your deployments as an environment variable ($SANDBOX_USER_NAME)
	1. **DO NOT STORE YOUR UNENCRYPTED KEY IN YOUR REPOSITORY**
		1. **Move all key files generated in the steps above (except <keyname>.enc) to a separate folder on your local machine and delete them from your repository**
1.  [Additional instructions on SF JWT auth flow here]( https://developer.salesforce.com/docs/atlas.en-us.sfdx_dev.meta/sfdx_dev/sfdx_dev_auth_jwt_flow.htm)
1. [Additional SFDX documentation that I used when developing this process](https://github.com/forcedotcom/sfdx-circleci)
	1. These instructions also tell you to store the output of <key name>.enc as an environment variable within CircleCI. I was not able to get this step to work... YMMV